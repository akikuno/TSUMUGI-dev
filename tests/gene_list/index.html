<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch Gzip JSON Data</title>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body {
            font-size: 1.2em;
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
        }

        textarea.geneList {
            font-size: inherit;
            font-family: inherit;
            max-width: 600px;
            height: 120px;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px;
            outline: none;
        }
    </style>
</head>

<body>

    <h1>Fetch Gene Data (Supports Gzip-Compressed JSON)</h1>

    <label for="geneList">Input Gene Symbols (Enter one per line)</label>
    <br>
    <textarea class="geneList" id="geneList" rows="5"></textarea>
    <br>
    <button onclick="fetchGeneData()">Submit</button>

    <script>
        document.getElementById("geneList").value = "Asxl1\r\nRab10\r\nDdx46";
    </script>

    <script>
        async function fetchGzippedJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }
                const compressedData = await response.arrayBuffer();
                const decompressedData = pako.inflate(compressedData, { to: "string" });
                return JSON.parse(decompressedData);
            } catch (error) {
                console.error(`Data fetch error (${url}):`, error);
                return null; // Skip on error
            }
        }

        function filterJson(jsonDataList, geneKeys) {
            // Set to store filtered data and avoid duplicates
            let elements = new Set();

            // Process each JSON dataset
            jsonDataList.forEach(jsonData => {
                jsonData.forEach(item => {
                    const data = item.data;

                    // Condition 1: If "node_color" exists, allow only values of 1
                    if ("node_color" in data && data.node_color !== 1) {
                        return;
                    }

                    // Condition 2: Allow only if both "source" and "target" are in the gene list
                    if ("source" in data && "target" in data) {
                        if (!geneKeys.includes(data.source) || !geneKeys.includes(data.target)) {
                            return;
                        }
                    }

                    // Condition 3: Allow only if "id" is in the gene list
                    if ("id" in data && !geneKeys.includes(data.id)) {
                        return;
                    }

                    // Convert JSON object to string to avoid duplicates
                    elements.add(JSON.stringify(item));
                });
            });

            // Convert Set back to JSON format
            return Array.from(elements).map(item => JSON.parse(item));
        }

        async function fetchGeneData() {
            let jsonDataList = []; // Store fetched data

            // Get the list of gene names
            const geneList = document.getElementById("geneList").value;
            const geneKeys = geneList.split(/\r?\n/).map(gene => gene.trim()).filter(gene => gene !== "");

            // Fetch JSON for each gene
            const fetchPromises = geneKeys.map(gene => fetchGzippedJson(`https://akikuno.github.io/TSUMUGI-dev/test-tsumugi/data/genesymbol/${gene}.json.gz`)); // REMOVE_THIS_LINE (for local test)

            /* REMOVE_THIS_LINE
            const fetchPromises = geneKeys.map(gene => fetchGzippedJson(`https://larc-tsukuba.github.io/tsumugi/data/genesymbol/${gene}.json.gz`));
            REMOVE_THIS_LINE */

            const results = await Promise.all(fetchPromises);

            // Add non-null data to the list
            jsonDataList = results.filter(data => data !== null);

            // Apply filtering
            const elements = filterJson(jsonDataList, geneKeys);

            // Count unique IDs
            const uniqueIds = new Set(elements.map(el => el.data.id).filter(id => id !== undefined));

            if (uniqueIds.size === 0) {
                alert("No similar phenotypes were found among the entered genes.");
                return;
            } else if (uniqueIds.size >= 200) {
                alert("Too many genes submitted. Please limit the number to 200 or fewer.");
                return;
            }

            localStorage.removeItem('elements');
            localStorage.setItem('elements', JSON.stringify(elements));
            window.open('./display_cytoscape.html', '_blank');
        }

    </script>

</body>

</html>
